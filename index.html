<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Checklist Pro - H√πng Hi·ªám</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f0f2f5; font-size: 14px; }
        .acc-checklist-dashboard { position: sticky; top: 20px; }
        .acc-checklist-status-select { font-weight: bold; }
        .acc-checklist-status-not-started { color: #dc3545; border-color: #dc3545; }
        .acc-checklist-status-in-progress { color: #ffc107; border-color: #ffc107; }
        .acc-checklist-status-completed { color: #198754; border-color: #198754; }
        #acc-checklist-reportModal .modal-body { white-space: pre-wrap; font-family: monospace; background-color: #f8f9fa; }
        .acc-checklist-floating-btn {
            background-color: #004a99;
            color: white;
            border: 2px solid white;
            border-radius: 25px;
            padding: 10px 15px;
            font-weight: bold;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
        }
        .acc-checklist-floating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.5);
        }
        .acc-checklist-floating-btn i {
            margin-right: 8px;
            font-size: 1.3rem;
        }
        #acc-checklist-floatingBtn {
            background-color: #dc3545;
        }
        #acc-checklist-mainAppModal .modal-dialog { max-width: 95vw; width: 1600px; }
        #acc-checklist-mainAppModal .modal-content { height: 90vh; }
        #acc-checklist-mainAppModal .modal-body { overflow-y: auto; background-color: #f8f9fa; }
        .acc-checklist-header-section {
            background-color: #004a99; color: white; padding: 1rem;
            border-radius: 0.5rem; margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .acc-checklist-task-card {
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 0.5rem;
        }
        .acc-checklist-task-card .card-header { font-weight: bold; font-size: 1.2rem; }
        .acc-checklist-notes-input { width: 100%; border: 1px solid #eee; padding: 5px; border-radius: 4px; }
        .acc-checklist-delete-btn { opacity: 0.5; transition: opacity 0.2s; }
        .list-group-item:hover .acc-checklist-delete-btn { opacity: 1; }
        .btn-loading .spinner-border { width: 1rem; height: 1rem; }
        .container {
            padding-top: 5rem;
            padding-bottom: 5rem;
        }
        .text-primary {
            color: #004a99 !important;
        }
        .rounded {
            border-radius: 0.5rem !important;
        }
        .shadow {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        }
        .acc-checklist-part-header {
            font-size: 1.8rem;
            font-weight: bold;
            color: #004a99;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #004a99;
        }
        /* === Style cho l·ªói ghi ch√∫ === */
        .acc-checklist-notes-input.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        .invalid-feedback {
            display: none;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
        /* === Style cho ch·ªânh s·ª≠a n·ªôi dung checklist === */
        .acc-checklist-task-name {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .acc-checklist-task-name:hover {
            background-color: #f8f9fa;
        }
        .acc-checklist-task-name.editing {
            background-color: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .acc-checklist-task-name-input {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container text-center py-5">
        <h1 class="mb-4 text-primary">K·∫æ TO√ÅN T·ªêT ƒê·ªÇ CH√öNG TA PH√ÅT TRI·ªÇN L√ÇU B·ªÄN - C√ÅC EM NH√â!</h1>
        <div class="d-flex justify-content-center">
            <img src="https://cdn.imgpile.com/f/im0vJIV_xl.png" alt="Giao di·ªán ƒë·∫πp" class="img-fluid rounded shadow" style="max-width: 80%; height: auto;">
        </div>
    </div>
    <div style="position: fixed; top: 60px; left: 20px; z-index: 1040; display: flex; flex-direction: column; gap: 10px;">
        <a href="https://erp-ideco.skyit.vn/#/app/dashboard/main" style="text-decoration: none;">
            <button id="acc-checklist-erpBtn" class="acc-checklist-floating-btn">
                <i class="bi bi-house-door-fill"></i> ERP HOME
            </button>
        </a>
        <button id="acc-checklist-floatingBtn" class="acc-checklist-floating-btn" data-bs-toggle="modal" data-bs-target="#acc-checklist-selectionModal">
            <i class="bi bi-card-checklist"></i> K·∫ø to√°n Checklist
        </button>
    </div>

    <!-- Modal ch·ªçn checklist -->
    <div class="modal fade" id="acc-checklist-selectionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-check-fill"></i> B·∫£ng Ch·ªçn Checklist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Ch·ªçn checklist ƒë√£ c√≥ ho·∫∑c t·∫°o m·ªõi.</p>
                    <div id="acc-checklist-accountantList" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-success" onclick="openNewAccountantModal()">
                        <i class="bi bi-plus-circle"></i> T·∫°o Checklist M·ªõi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ch√≠nh c·ªßa ·ª©ng d·ª•ng -->
    <div class="modal fade" id="acc-checklist-mainAppModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title text-primary" id="acc-checklist-mainAppModalLabel"></h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm me-auto ms-4" onclick="backToSelection()">
                        <i class="bi bi-arrow-left-right"></i> Quay l·∫°i B·∫£ng Ch·ªçn
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="header-section acc-checklist-header-section text-center">
                            <h2><i class="bi bi-card-checklist"></i> B·∫¢NG CHECKLIST C√îNG VI·ªÜC K·∫æ TO√ÅN TH√ÅNG - B√ÅO C√ÅO BGƒê CU·ªêI K·ª≤</h2>
                            <h5 id="acc-checklist-currentMonth"></h5>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <div class="card acc-checklist-dashboard">
                                    <div class="card-header bg-dark text-white"><i class="bi bi-speedometer2"></i> B·∫£ng ƒêi·ªÅu Khi·ªÉn</div>
                                    <div class="card-body">
                                        <h5>T·ªïng Quan Ti·∫øn ƒê·ªô</h5>
                                        <div class="progress" style="height: 30px;"><div id="acc-checklist-totalProgressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width: 0%; font-size: 1rem;">0%</div></div>
                                        <hr>
                                        <div id="acc-checklist-summary">
                                            <p class="mb-1"><strong>T·ªïng s·ªë c√¥ng vi·ªác:</strong> <span id="acc-checklist-totalTasks">0</span></p>
                                            <p class="mb-1 text-success"><strong><i class="bi bi-check-circle-fill"></i> Ho√†n th√†nh:</strong> <span id="acc-checklist-completedTasks">0</span></p>
                                            <p class="mb-1 text-warning"><strong><i class="bi bi-play-circle-fill"></i> ƒêang l√†m:</strong> <span id="acc-checklist-inProgressTasks">0</span></p>
                                            <p class="mb-1 text-danger"><strong><i class="bi bi-x-circle-fill"></i> Ch∆∞a l√†m:</strong> <span id="acc-checklist-notStartedTasks">0</span></p>
                                        </div>
                                        <hr>
                                        <div class="d-grid">
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#acc-checklist-reportModal"><i class="bi bi-file-earmark-text"></i> T·∫°o B√°o C√°o Nhanh</button>
                                        </div>
                                        <div class="d-grid mt-3">
                                            <button class="btn btn-warning" onclick="confirmRefreshChecklist()"><i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi k·ª≥ m·ªõi</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-9">
                                <div id="acc-checklist-taskList"></div>
                                <div class="d-flex justify-content-end mt-3">
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#acc-checklist-addTaskModal"><i class="bi bi-plus-circle"></i> Th√™m C√¥ng Vi·ªác M·ªõi</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal t·∫°o checklist m·ªõi -->
    <div class="modal fade" id="acc-checklist-newAccountantModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">T·∫°o Checklist M·ªõi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <label for="acc-checklist-newAccountantNameInput" class="form-label">Nh·∫≠p t√™n K·∫ø to√°n vi√™n:</label>
                    <input type="text" id="acc-checklist-newAccountantNameInput" class="form-control" placeholder="V√≠ d·ª•: Nguy·ªÖn Th·ªã Lan">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" id="acc-checklist-saveNewAccountantBtn" class="btn btn-primary" onclick="createNewChecklist()">L∆∞u v√† B·∫Øt ƒë·∫ßu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal th√™m c√¥ng vi·ªác m·ªõi -->
    <div class="modal fade" id="acc-checklist-addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Th√™m C√¥ng Vi·ªác M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="acc-checklist-addTaskForm">
                        <div class="mb-3">
                            <label for="acc-checklist-taskName" class="form-label">T√™n c√¥ng vi·ªác</label>
                            <input type="text" class="form-control" id="acc-checklist-taskName" required>
                        </div>
                        <div class="mb-3">
                            <label for="acc-checklist-taskPart" class="form-label">Ph√≤ng ban/Ph·∫ßn</label>
                            <select class="form-select" id="acc-checklist-taskPart" required>
                                <option value="K·∫ø to√°n T·ªïng h·ª£p">K·∫ø to√°n T·ªïng h·ª£p</option>
                                <option value="K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu">K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="acc-checklist-taskCategory" class="form-label">Ph√¢n lo·∫°i</label>
                            <select class="form-select" id="acc-checklist-taskCategory" required>
                                <option value="ƒê·∫ßu k·ª≥">C√¥ng vi·ªác ƒë·∫ßu k·ª≥</option>
                                <option value="Trong k·ª≥">C√¥ng vi·ªác trong k·ª≥</option>
                                <option value="Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o">C√¥ng vi·ªác cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="acc-checklist-taskDeadline" class="form-label">H·∫°n ch√≥t (T√πy ch·ªçn)</label>
                            <input type="date" class="form-control" id="acc-checklist-taskDeadline">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="addTask()">Th√™m</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal b√°o c√°o -->
    <div class="modal fade" id="acc-checklist-reportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">B√°o C√°o Nhanh Ti·∫øn ƒê·ªô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="acc-checklist-reportContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="copyReport()">
                        <i class="bi bi-clipboard"></i> Sao ch√©p
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // üîë C·∫•u h√¨nh Firebase
    const firebaseConfig = { 
        apiKey : "AIzaSyB4cHf-DQ3iczPH25ocMY1_dL5gbSGzLKg" , 
        authDomain : "baocaonhanh-8cfc6.firebaseapp.com" , 
        databaseURL : "https://baocaonhanh-8cfc6-default-rtdb.firebaseio.com" , 
        projectId : "baocaonhanh-8cfc6" , 
        storageBucket : "baocaonhanh-8cfc6.firebasestorage.app" , 
        messagingSenderId : "912512588357" , 
        appId : "1:912512588357:web:d1956a0aaefb7be6c4212c" , 
        measurementId : "G-SJM5VBK3Z2" 
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentAccountantId = null;
    let currentChecklistData = null;
    let selectionModal, mainAppModal, newAccountantModal, addTaskModal;

    // === ƒê·ªãnh nghƒ©a placeholder theo ph·∫ßn ===
    const NOTE_PLACEHOLDERS = {
        'K·∫ø to√°n T·ªïng h·ª£p': 'Em h√£y ƒëi·ªÉm l·∫°i ng·∫Øn g·ªçn - x√∫c t√≠ch c√¥ng vi·ªác ho√†n th√†nh  .',
        'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu': 'Em h√£y ƒëi·ªÉm l·∫°i c√¥ng vi·ªác ho√†n th√†nh '
    };

    // === D·ªØ li·ªáu c√¥ng vi·ªác ban ƒë·∫ßu ===
    const initialTasks = [
        // ===== PH·∫¶N 1: K·∫æ TO√ÅN T·ªîNG H·ª¢P =====
        { id: 1, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'ƒê·∫ßu k·ª≥', name: 'K·∫øt chuy·ªÉn l√£i/l·ªó ch∆∞a ph√¢n ph·ªëi t·ª´ k·ª≥ tr∆∞·ªõc', status: 'not-started', notes: '', deadline: '' },
        { id: 2, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'ƒê·∫ßu k·ª≥', name: 'Ki·ªÉm tra s·ªë d∆∞ ƒë·∫ßu k·ª≥ c·ªßa c√°c t√†i kho·∫£n tr√™n b·∫£ng c√¢n ƒë·ªëi', status: 'not-started', notes: '', deadline: '' },
        { id: 3, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Trong k·ª≥', name: 'X·ª≠ l√Ω - ƒëi·ªÅu ph·ªëi ho·∫°t ƒë·ªông mua h√†ng: h√≥a ƒë∆°n - ch·ª©ng t·ª´ - h√†ng h√≥a- phi·∫øu nh·∫≠p(ERP/MISA) ', status: 'not-started', notes: 'ƒê·ªëi chi·∫øu v·ªõi h·ª£p ƒë·ªìng, bi√™n b·∫£n giao h√†ng...', deadline: '' },
        { id: 4, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Trong k·ª≥', name: 'X·ª≠ l√Ω -ƒëi·ªÅu ph·ªëi ho·∫°t ƒë·ªông b√°n h√†ng: gi√°m s√°t - ki·ªÉm tra - h√≥a ƒë∆°n - phi·∫øu xu·∫•t ( tr√™n ERP/MISA)', status: 'not-started', notes: 'Ki·ªÉm tra ch√≠nh s√°ch chi·∫øt kh·∫•u, c√¥ng n·ª£', deadline: '' },
        { id: 5, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Trong k·ª≥', name: 'H·∫°ch to√°n v√† ki·ªÉm tra h·∫°ch to√°n c√°c h√≥a ƒë∆°n mua - b√°n - ƒëi·ªÅu ch·ªânh - ƒë·ªïi tr·∫£ tr√™n Misa/ERP ', status: 'not-started', notes: '', deadline: '' },
        { id: 6, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Trong k·ª≥', name: 'H·∫°ch to√°n v√† ƒë·ªëi chi·∫øu kho·∫£n ph·∫£i tr·∫£/ ph·∫£i thu ph√°t sinh v√†o s·ªï', status: 'not-started', notes: '', deadline: '' },
        { id: 7, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Trong k·ª≥', name: 'H·∫°ch to√°n c√°c nghi·ªáp v·ª• li√™n quan ƒë·∫øn ti·ªÅn m·∫∑t, sao k√™ ng√¢n h√†ng/ theo d√µi k√™ ∆∞·ªõc vay..', status: 'not-started', notes: 'ƒê·ªëi chi·∫øu s·ªï ph·ª• ng√¢n h√†ng h√†ng ng√†y/tu·∫ßn', deadline: '' },
        { id: 8, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Trong k·ª≥', name: 'L·∫≠p b·∫£n k√™ chi ncc ƒë·ªãnh k·ª≥ cho BGƒê/ Ki·ªÉm tra s·ªï/ d√≤ng ti·ªÅn/', status: 'not-started', notes: '', deadline: '' },
        { id: 9, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Trong k·ª≥', name: 'ƒê·ªëi chi·∫øu thanh to√°n thu h·ªô t·ª´ ƒë∆°n b√°n / ghi nh·∫≠n doanh thu trong k·ª≥ theo TK cty c√πng BGƒê', status: 'not-started', notes: '', deadline: '' },       
        { id: 10, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Trong k·ª≥', name: 'X·ª≠ l√Ω c√°c ph√°t sinh li√™n quan ƒë·∫øn lao ƒë·ªông, l∆∞∆°ng, kho·∫£n t·∫°m ·ª©ng, kh√°ch ', status: 'not-started', notes: '', deadline: '' },     
        { id: 11, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'T√≠nh v√† tr√≠ch kh·∫•u hao - ph√¢n b·ªï CCDC tr√™n Misa/ ERP m·ª•c t·∫°m ·ª©ng', status: 'not-started', notes: '', deadline: '' },
        { id: 12, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'H·ªçp ƒë√°nh gi√° b·ªô ph·∫≠n: t·ªïng h·ª£p d·ªØ li·ªáu n·ªôi b·ªô', status: 'not-started', notes: '', deadline: '' },
        { id: 13, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'Ph·ªëi h·ª£p ki·ªÉm k√™ h√†ng h√≥a- ch·ª©ng t·ª´ v·ªõi kho ', status: 'not-started', notes: '', deadline: '' },
        { id: 14, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'Ra s√≥t khai chi/ thu tr√™n ERP/MISA ƒë·ªÉ ho√†n th√†nh b√°o c√°o', status: 'not-started', notes: '', deadline: '' },
        { id: 15, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'ƒê·ªëi chi·∫øu s·ªë li·ªáu b√°o c√°o tr√™n ERP/Misa / ki·ªÉm tra', status: 'not-started', notes: '', deadline: '' },
        { id: 16, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'L·∫≠p khi l∆∞∆°ng th∆∞·ªüng tr√™n ERP /ho·∫°ch to√°n chi l∆∞∆°ng tr√™n Misa ', status: 'not-started', notes: 'H·∫°n cu·ªëi l√† ng√†y 20 c·ªßa th√°ng sau', deadline: '' },
        { id: 17, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'L·∫≠p t·ªù khai thu·∫ø TNCN v√† n·ªôp (n·∫øu theo th√°ng/qu√Ω)', status: 'not-started', notes: '', deadline: '' },
        { id: 18, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'L·∫≠p h·∫°ch to√°n BHXH-BHYT-BHTN ph√°t sinh - xem l·∫°i k·ªπ', status: 'not-started', notes: '', deadline: '' },
        { id: 19, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'T·∫°m t√≠nh thu·∫ø TNDN v√† n·ªôp (n·∫øu c√≥)', status: 'not-started', notes: '', deadline: '' },
        { id: 20, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'Th·ª±c hi·ªán c√°c b√∫t to√°n k·∫øt chuy·ªÉn doanh thu, chi ph√≠', status: 'not-started', notes: '', deadline: '' },
        { id: 21, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'ƒê·ªëi so√°t x√°c th·ª±c b√°o c√°o k·∫øt qu·∫£ kinh doanh ERP/Misa', status: 'not-started', notes: '', deadline: '' },
        { id: 22, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'L·∫≠p B·∫£ng c√¢n ƒë·ªëi s·ªë ph√°t sinh', status: 'not-started', notes: 'Ki·ªÉm tra t·ªïng N·ª£ = t·ªïng C√≥', deadline: '' },
        { id: 23, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'L·∫≠p B√°o c√°o k·∫øt qu·∫£ ho·∫°t ƒë·ªông kinh doanh (ERP)', status: 'not-started', notes: '', deadline: '' },
        { id: 24, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'L·∫≠p B·∫£ng c√¢n ƒë·ªëi k·∫ø to√°n - b√°o c√°o trong k·ª≥ MISA', status: 'not-started', notes: '', deadline: '' },
        { id: 25, part: 'K·∫ø to√°n T·ªïng h·ª£p', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: 'In v√† l∆∞u tr·ªØ s·ªï s√°ch, ch·ª©ng t·ª´ k·∫ø to√°n theo quy ƒë·ªãnh', status: 'not-started', notes: '', deadline: '' },
        // ===== PH·∫¶N 2: K·∫æ TO√ÅN B√ÅN H√ÄNG, KHO, C√îNG N·ª¢ PH·∫¢I THU =====
        { id: 26, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'ƒê·∫ßu k·ª≥', name: '[B√°n h√†ng] Ki·ªÉm tra - ƒë·ªëi s√≥t kh·∫£n ghi nh·∫≠n thanh to√°n c√°c ƒë∆°n h√†ng tr√™n TK hay ƒë√£ ghi nh·∫≠n doanh thu ch∆∞a?', status: 'not-started', notes: '', deadline: '' },
        { id: 27, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'ƒê·∫ßu k·ª≥', name: '[Kho] Ki·ªÉm tra c√°c h√≥a ƒë∆°n xu·∫•t k√Ω tr√™n Misa v√† h·∫°ch to√°n doanh thu trong Misa ', status: 'not-started', notes: '', deadline: '' },
        { id: 28, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'ƒê·∫ßu k·ª≥', name: '[C√¥ng n·ª£] Ra so√°t l·∫°i c√°c khai b√°o h√≥a ƒë∆°n c·ªßa ƒë∆°n h√†ng ch∆∞a b·∫•m xu·∫•t tr√™n ERP ƒë·ªÉ ghi nh·∫≠n doanh thu', status: 'not-started', notes: '', deadline: '' },
        { id: 29, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Trong k·ª≥', name: '[B√°n h√†ng] L·∫≠p v√† xu·∫•t h√≥a ƒë∆°n b√°n h√†ng h√†ng ng√†y, h·∫°ch to√°n doanh thu', status: 'not-started', notes: '', deadline: '' },
        { id: 30, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Trong k·ª≥', name: '[B√°n h√†ng] X·ª≠ l√Ω c√°c kho·∫£n gi·∫£m tr·ª´: chi·∫øt kh·∫•u, h√†ng b√°n b·ªã tr·∫£ l·∫°i', status: 'not-started', notes: '', deadline: '' },
        { id: 31, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Trong k·ª≥', name: '[Kho] L·∫≠p phi·∫øu nh·∫≠p kho, xu√°t kho khi c√≥ ph√°t sinh, h·∫°ch to√°n v√†o ph·∫ßn m·ªÅm ERP/MISA', status: 'not-started', notes: '', deadline: '' },
        { id: 32, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Trong k·ª≥', name: '[Kho] Gi√°m s√°t t√¨nh h√¨nh nh·∫≠p-xu·∫•t-t·ªìn kho h√†ng ng√†y tr√™n ERP/Misa cho kh·ªõp', status: 'not-started', notes: '', deadline: '' },
        { id: 33, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Trong k·ª≥', name: '[C√¥ng n·ª£] Theo d√µi, c·∫≠p nh·∫≠t c√°c kho·∫£n ph·∫£i thu ph√°t sinh trong ng√†y v·ªõi qu·∫£n l√Ω k·∫ø to√°n/BGƒê', status: 'not-started', notes: '', deadline: '' },
        { id: 34, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Trong k·ª≥', name: '[C√¥ng n·ª£] Ph√¥i h·ª£p v·ªõi kinh doanh ƒë·ªëi chi·∫øu c√¥ng n·ª£- nh·∫Øc thu h·ªëi n·ª£ trong k·ª≥', status: 'not-started', notes: '', deadline: '' },
        { id: 35, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: '[B√°n h√†ng] T·ªïng h·ª£p h√≥a ƒë∆°n, l·∫≠p b√°o c√°o b√°n h√†ng, b√°o c√°o doanh thu', status: 'not-started', notes: '', deadline: '' },
        { id: 36, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: '[Kho] Tham gia ki·ªÉm k√™ kho cu·ªëi th√°ng', status: 'not-started', notes: '', deadline: '' },
        { id: 37, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: '[Kho] L·∫≠p b√°o c√°o Nh·∫≠p - Xu·∫•t - T·ªìn kho th√°ng', status: 'not-started', notes: 'ƒê·ªëi chi·∫øu v·ªõi k·∫ø to√°n t·ªïng h·ª£p', deadline: '' },
        { id: 38, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: '[C√¥ng n·ª£] ƒê·ªëi chi·∫øu c√¥ng n·ª£ ph·∫£i thu v·ªõi t·∫•t c·∫£ kh√°ch h√†ng cu·ªëi th√°ng', status: 'not-started', notes: '', deadline: '' },
        { id: 39, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: '[C√¥ng n·ª£] L·∫≠p b√°o c√°o t·ªïng h·ª£p c√¥ng n·ª£ ph·∫£i thu, ph√¢n t√≠ch tu·ªïi n·ª£', status: 'not-started', notes: '', deadline: '' },
        { id: 40, part: 'K·∫ø to√°n B√°n h√†ng, Kho & C√¥ng n·ª£ Ph·∫£i thu', category: 'Cu·ªëi k·ª≥ - Thu·∫ø & B√°o c√°o', name: '[B√°o c√°o] K·∫øt chuy·ªÉn b√°o c√°o t·ªïng h·ª£p cho k√™ to√°n t·ªïng h·ª£p/ k·∫øt to√°n tr∆∞·ªüng', status: 'not-started', notes: '', deadline: '' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        selectionModal = new bootstrap.Modal(document.getElementById('acc-checklist-selectionModal'));
        mainAppModal = new bootstrap.Modal(document.getElementById('acc-checklist-mainAppModal'));
        newAccountantModal = new bootstrap.Modal(document.getElementById('acc-checklist-newAccountantModal'));
        addTaskModal = new bootstrap.Modal(document.getElementById('acc-checklist-addTaskModal'));
        document.getElementById('acc-checklist-selectionModal').addEventListener('shown.bs.modal', loadAccountantList);
    });

    // === C·∫¨P NH·∫¨T: H√†m updateStatus c√≥ ki·ªÉm tra ghi ch√∫ ===
    function updateStatus(taskId, status, selectElement) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (!task) return;

        if (status === 'completed') {
            const noteLength = (task.notes || '').trim().length;
            if (noteLength < 20) {
                // Ho√†n l·∫°i tr·∫°ng th√°i c≈©
                selectElement.value = task.status;

                // Hi·ªÉn th·ªã l·ªói
                const noteTextarea = document.querySelector(`textarea[onchange*="updateNotes(${taskId},"]`);
                if (noteTextarea) {
                    noteTextarea.classList.add('is-invalid');
                    let errorEl = noteTextarea.parentElement.querySelector('.invalid-feedback');
                    if (!errorEl) {
                        errorEl = document.createElement('div');
                        errorEl.className = 'invalid-feedback';
                        errorEl.style.display = 'block';
                        noteTextarea.parentElement.appendChild(errorEl);
                    }
                    errorEl.textContent = 'Ghi ch√∫ khi ho√†n th√†nh ph·∫£i c√≥ √≠t nh·∫•t 20 k√Ω t·ª±.';
                    noteTextarea.focus();
                }
                return;
            } else {
                const noteTextarea = document.querySelector(`textarea[onchange*="updateNotes(${taskId},"]`);
                if (noteTextarea) {
                    noteTextarea.classList.remove('is-invalid');
                    const errorEl = noteTextarea.parentElement.querySelector('.invalid-feedback');
                    if (errorEl) errorEl.remove();
                }
            }
        }

        task.status = status;
        updateSelectColor(selectElement, status);
        updateDashboard();
        saveTasks();
    }

    function updateNotes(taskId, notes) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (task) { task.notes = notes; saveTasks(); }
    }

    function updateDeadline(taskId, deadline) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (task) { task.deadline = deadline; saveTasks(); }
    }

    // === T√çNH NƒÇNG M·ªöI: Ch·ªânh s·ª≠a n·ªôi dung c√¥ng vi·ªác ===
    function editTaskName(taskId) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        const taskElement = document.querySelector(`[data-task-id="${taskId}"] .acc-checklist-task-name`);
        if (!taskElement) return;
        
        // T·∫°o input ƒë·ªÉ ch·ªânh s·ª≠a
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'acc-checklist-task-name-input';
        input.value = task.name;
        
        // Thay th·∫ø n·ªôi dung b·∫±ng input
        taskElement.classList.add('editing');
        taskElement.innerHTML = '';
        taskElement.appendChild(input);
        input.focus();
        
        // X·ª≠ l√Ω khi k·∫øt th√∫c ch·ªânh s·ª≠a
        const finishEdit = () => {
            const newName = input.value.trim();
            if (newName && newName !== task.name) {
                updateTaskName(taskId, newName);
            } else {
                taskElement.textContent = task.name;
            }
            taskElement.classList.remove('editing');
        };
        
        input.addEventListener('blur', finishEdit);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                finishEdit();
            }
        });
    }

    function updateTaskName(taskId, newName) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (task) { 
            task.name = newName; 
            saveTasks();
            // Kh√¥ng c·∫ßn render l·∫°i to√†n b·ªô, ch·ªâ c·∫≠p nh·∫≠t tr·ª±c ti·∫øp
            const taskElement = document.querySelector(`[data-task-id="${taskId}"] .acc-checklist-task-name`);
            if (taskElement) {
                taskElement.textContent = newName;
            }
        }
    }

    // === T√çNH NƒÇNG M·ªöI: X√≥a c√¥ng vi·ªác ===
    function deleteTask(taskId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y?')) {
            const taskIndex = currentChecklistData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                currentChecklistData.tasks.splice(taskIndex, 1);
                saveTasks();
                renderTasks(currentChecklistData.tasks);
            }
        }
    }

    async function saveTasks() {
        if (!currentAccountantId) return;
        try {
            await database.ref(`checklists/${currentAccountantId}/tasks`).set(currentChecklistData.tasks);
        } catch (error) {
            console.error("L·ªói khi l∆∞u:", error);
            alert("Kh√¥ng th·ªÉ l∆∞u thay ƒë·ªïi.");
        }
    }

    function renderTasks(tasks) {
        const now = new Date();
        document.getElementById('acc-checklist-currentMonth').innerText = `K·ª≤ B√ÅO C√ÅO: TH√ÅNG ${now.getMonth() + 1} NƒÇM ${now.getFullYear()}`;
        const taskListDiv = document.getElementById('acc-checklist-taskList');
        taskListDiv.innerHTML = '';

        const parts = [...new Set(tasks.map(t => t.part))];
        parts.forEach(part => {
            const partHeader = document.createElement('h2');
            partHeader.className = 'acc-checklist-part-header';
            partHeader.innerHTML = `<i class="bi bi-collection-fill"></i> ${part}`;
            taskListDiv.appendChild(partHeader);

            const tasksInPart = tasks.filter(t => t.part === part);
            const categories = [...new Set(tasksInPart.map(t => t.category))];
            categories.forEach(category => {
                const card = document.createElement('div');
                card.className = 'card acc-checklist-task-card';
                let iconClass = 'bi-journal-bookmark';
                if (category.includes('Trong k·ª≥')) iconClass = 'bi-calendar3-week';
                if (category.includes('Cu·ªëi k·ª≥')) iconClass = 'bi-file-earmark-zip';
                card.innerHTML = `<div class="card-header"><i class="bi ${iconClass}"></i> ${category}</div>`;
                const table = document.createElement('table');
                table.className = 'table table-hover table-striped mb-0';
                table.innerHTML = `
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 40%;">N·ªôi dung c√¥ng vi·ªác</th>
                            <th style="width: 15%;">Tr·∫°ng th√°i</th>
                            <th style="width: 15%;">H·∫°n ch√≥t</th>
                            <th style="width: 20%;">Ghi ch√∫</th>
                            <th style="width: 5%;">X√≥a</th>
                        </tr>
                    </thead>`;
                const tbody = document.createElement('tbody');
                tasksInPart.filter(t => t.category === category).forEach(task => {
                    const placeholder = NOTE_PLACEHOLDERS[task.part] || 'Vui l√≤ng m√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác ƒë√£ th·ª±c hi·ªán...';
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-task-id', task.id);
                    tr.innerHTML = `
                        <td>${task.id}</td>
                        <td>
                            <div class="acc-checklist-task-name" onclick="editTaskName(${task.id})">
                                ${task.name}
                            </div>
                        </td>
                        <td>
                            <select class="form-select form-select-sm acc-checklist-status-select" 
                                    onchange="updateStatus(${task.id}, this.value, this)">
                                <option value="not-started">Ch∆∞a l√†m</option>
                                <option value="in-progress">ƒêang l√†m</option>
                                <option value="completed">Ho√†n th√†nh</option>
                            </select>
                        </td>
                        <td><input type="date" class="form-control form-control-sm" value="${task.deadline || ''}" onchange="updateDeadline(${task.id}, this.value)"></td>
                        <td>
                            <textarea class="form-control form-control-sm acc-checklist-notes-input" 
                                      rows="2" 
                                      placeholder="${placeholder}"
                                      onchange="updateNotes(${task.id}, this.value)">${task.notes || ''}</textarea>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm acc-checklist-delete-btn" onclick="deleteTask(${task.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>`;
                    const select = tr.querySelector('.acc-checklist-status-select');
                    select.value = task.status;
                    updateSelectColor(select, task.status);
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                card.appendChild(table);
                taskListDiv.appendChild(card);
            });
        });
        updateDashboard();
    }

    // === C√°c h√†m c√≤n l·∫°i gi·ªØ nguy√™n ===
    async function loadAccountantList() {
        const listDiv = document.getElementById('acc-checklist-accountantList');
        listDiv.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>`;
        try {
            const snapshot = await database.ref('checklists').once('value');
            const data = snapshot.val();
            listDiv.innerHTML = '';
            if (data) {
                const validChecklists = Object.values(data).filter(acc => acc && acc.id && acc.accountantName);
                if (validChecklists.length > 0) {
                    validChecklists.forEach(acc => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        item.innerHTML = `
                            <a href="#" class="text-decoration-none text-dark flex-grow-1" onclick="event.preventDefault(); loadChecklistFor('${acc.id}')">
                                <strong>${acc.accountantName}</strong>
                                <br><small class="text-muted">Ng√†y l·∫≠p: ${acc.creationDate}</small>
                            </a>
                            <button class="btn btn-outline-danger btn-sm acc-checklist-delete-btn" onclick="confirmDeleteAccountant(this, '${acc.id}', '${acc.accountantName}')"><i class="bi bi-trash-fill"></i></button>`;
                        listDiv.appendChild(item);
                    });
                } else {
                    listDiv.innerHTML = '<p class="text-center text-muted p-3">Ch∆∞a c√≥ checklist n√†o.</p>';
                }
            } else {
                listDiv.innerHTML = '<p class="text-center text-muted p-3">Ch∆∞a c√≥ checklist n√†o.</p>';
            }
        } catch (error) {
            console.error("L·ªói khi t·∫£i danh s√°ch:", error);
            listDiv.innerHTML = '<p class="text-center text-danger p-3">L·ªói k·∫øt n·ªëi CSDL.</p>';
        }
    }

    function openNewAccountantModal() {
        document.getElementById('acc-checklist-newAccountantNameInput').value = '';
        newAccountantModal.show();
    }

    async function createNewChecklist() {
        const nameInput = document.getElementById('acc-checklist-newAccountantNameInput');
        const name = nameInput.value.trim();
        const saveBtn = document.getElementById('acc-checklist-saveNewAccountantBtn');
        if (!name) { alert('Vui l√≤ng nh·∫≠p t√™n.'); return; }
        setButtonLoading(saveBtn, true);
        try {
            const newChecklistRef = database.ref('checklists').push();
            const newChecklistId = newChecklistRef.key;
            const newChecklist = {
                id: newChecklistId,
                accountantName: name,
                creationDate: new Date().toLocaleDateString('vi-VN'),
                tasks: JSON.parse(JSON.stringify(initialTasks))
            };
            await newChecklistRef.set(newChecklist);
            newAccountantModal.hide();
            loadChecklistFor(newChecklistId);
        } catch (error) {
            console.error("L·ªói khi t·∫°o checklist m·ªõi:", error);
            alert("ƒê√£ x·∫£y ra l·ªói khi t·∫°o m·ªõi.");
        } finally {
            setButtonLoading(saveBtn, false);
        }
    }

    async function loadChecklistFor(accountantId) {
        try {
            const snapshot = await database.ref('checklists/' + accountantId).once('value');
            currentChecklistData = snapshot.val();
            if (currentChecklistData) {
                currentAccountantId = accountantId;
                document.getElementById('acc-checklist-mainAppModalLabel').innerHTML = `<i class="bi bi-person-fill"></i> Checklist c·ªßa: <strong>${currentChecklistData.accountantName}</strong>`;
                renderTasks(currentChecklistData.tasks);
                selectionModal.hide();
                mainAppModal.show();
            } else {
                alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.');
                loadAccountantList();
            }
        } catch (error) {
            console.error("L·ªói khi t·∫£i checklist:", error);
            alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu checklist.");
        }
    }

    function confirmDeleteAccountant(button, id, name) {
        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a checklist c·ªßa "${name}" kh√¥ng?`)) {
            deleteAccountant(button, id);
        }
    }

    async function deleteAccountant(button, id) {
        setButtonLoading(button, true);
        try {
            await database.ref('checklists/' + id).remove();
            loadAccountantList();
        } catch(error) {
            console.error("L·ªói khi x√≥a:", error);
            alert("X√≥a th·∫•t b·∫°i.");
            setButtonLoading(button, false);
        }
    }

    function backToSelection() {
        mainAppModal.hide();
        selectionModal.show();
    }

    window.addTask = function() {
        const name = document.getElementById('acc-checklist-taskName').value;
        const part = document.getElementById('acc-checklist-taskPart').value;
        const category = document.getElementById('acc-checklist-taskCategory').value;
        const deadline = document.getElementById('acc-checklist-taskDeadline').value;
        if (name && part && category) {
            const newId = currentChecklistData.tasks.length > 0 ? Math.max(...currentChecklistData.tasks.map(t => t.id)) + 1 : 1;
            const newTask = {
                id: newId, part: part, category: category, name: name,
                status: 'not-started', notes: '', deadline: deadline
            };
            currentChecklistData.tasks.push(newTask);
            saveTasks();
            renderTasks(currentChecklistData.tasks);
            addTaskModal.hide();
            document.getElementById('acc-checklist-addTaskForm').reset();
        } else {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin c√¥ng vi·ªác.');
        }
    }

    function updateDashboard() {
        if (!currentChecklistData) return;
        const tasks = currentChecklistData.tasks;
        const total = tasks.length, completed = tasks.filter(t => t.status === 'completed').length;
        const inProgress = tasks.filter(t => t.status === 'in-progress').length;
        document.getElementById('acc-checklist-totalTasks').innerText = total;
        document.getElementById('acc-checklist-completedTasks').innerText = completed;
        document.getElementById('acc-checklist-inProgressTasks').innerText = inProgress;
        document.getElementById('acc-checklist-notStartedTasks').innerText = total - completed - inProgress;
        const progressBar = document.getElementById('acc-checklist-totalProgressBar');
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        progressBar.style.width = `${percentage}%`;
        progressBar.innerText = `${percentage}%`;
    }

    function updateSelectColor(select, status) {
        select.className = 'form-select form-select-sm acc-checklist-status-select';
        if (status === 'not-started') select.classList.add('acc-checklist-status-not-started');
        else if (status === 'in-progress') select.classList.add('acc-checklist-status-in-progress');
        else if (status === 'completed') select.classList.add('acc-checklist-status-completed');
    }

    function setButtonLoading(button, isLoading) {
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`;
        } else {
            if (button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
            }
            button.disabled = false;
        }
    }

    document.getElementById('acc-checklist-reportModal').addEventListener('show.bs.modal', function () {
        if (!currentChecklistData) return;
        const { accountantName, tasks } = currentChecklistData;
        const now = new Date();
        const month = now.getMonth() + 1;
        const year = now.getFullYear();
        const total = tasks.length;
        const completed = tasks.filter(t => t.status === 'completed').length;
        const inProgress = tasks.filter(t => t.status === 'in-progress').length;
        const notStarted = total - completed - inProgress;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        let reportText = `B√ÅO C√ÅO TI·∫æN ƒê·ªò CHECKLIST C√îNG VI·ªÜC TH√ÅNG ${month}/${year}\n`;
        reportText += `Ng∆∞·ªùi th·ª±c hi·ªán: ${accountantName}\n`;
        reportText += `Ng√†y b√°o c√°o: ${now.toLocaleDateString('vi-VN')}\n`;
        reportText += `===================================================\n`;
        reportText += `T·ªîNG QUAN:\n`;
        reportText += `- Ho√†n th√†nh: ${completed}/${total} c√¥ng vi·ªác (${percentage}%)\n`;
        reportText += `- ƒêang th·ª±c hi·ªán: ${inProgress}\n`;
        reportText += `- Ch∆∞a th·ª±c hi·ªán: ${notStarted}\n`;
        reportText += `CHI TI·∫æT C√ÅC C√îNG VI·ªÜC CH∆ØA HO√ÄN TH√ÄNH:\n`;
        reportText += `---------------------------------------------------\n`;
        const uncompletedTasks = tasks.filter(t => t.status !== 'completed');
        if (uncompletedTasks.length > 0) {
            const parts = [...new Set(uncompletedTasks.map(task => task.part))];
            parts.forEach(part => {
                reportText += `\n[${part.toUpperCase()}]\n`;
                const tasksInPart = uncompletedTasks.filter(t => t.part === part);
                tasksInPart.forEach(task => {
                    let statusText = task.status === 'in-progress' ? 'ƒêang l√†m' : 'Ch∆∞a l√†m';
                    reportText += `- ${task.name} -> [${statusText}]\n`;
                    if (task.notes) {
                        reportText += `  Ghi ch√∫: ${task.notes}\n`;
                    }
                });
            });
        } else {
            reportText += `\n>>> TUY·ªÜT V·ªúI! T·∫•t c·∫£ c√¥ng vi·ªác ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh.\n`;
        }
        document.getElementById('acc-checklist-reportContent').innerText = reportText;
    });

    window.copyReport = function() {
        navigator.clipboard.writeText(document.getElementById('acc-checklist-reportContent').innerText)
            .then(() => alert('ƒê√£ sao ch√©p b√°o c√°o!'))
            .catch(err => console.error('Kh√¥ng th·ªÉ sao ch√©p: ', err));
    };

    function confirmRefreshChecklist() {
        if (confirm('L√†m m·ªõi k·ª≥ m·ªõi? To√†n b·ªô tr·∫°ng th√°i v√† ghi ch√∫ s·∫Ω b·ªã x√≥a.')) {
            refreshChecklist();
        }
    }

    async function refreshChecklist() {
        if (!currentChecklistData || !currentAccountantId) return;
        currentChecklistData.tasks.forEach(task => {
            task.status = 'not-started';
            task.notes = '';
        });
        try {
            await saveTasks();
            renderTasks(currentChecklistData.tasks);
            alert('ƒê√£ l√†m m·ªõi checklist th√†nh c√¥ng!');
        } catch (error) {
            console.error("L·ªói khi l√†m m·ªõi:", error);
            alert("L√†m m·ªõi th·∫•t b·∫°i.");
        }
    }
    </script>
</body>
</html>
